{"id":"guide/observables-in-angular","title":"Angular 中的可观察对象","contents":"<div class=\"content\">\n  <h1 id=\"observables-in-angular\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"9eb1ivnhe71e8ej18m44nssym\">Angular 中的可观察对象<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/observables-in-angular#observables-in-angular\"><i class=\"material-icons\">link</i></a></h1>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"59syqtu3evtp1kvoz5g90hm9y\">Angular 使用可观察对象作为处理各种常用异步操作的接口。比如：</p>\n<!--todo: Have Alex review this -->\n<!-- *   You can define [custom events](guide/event-binding#custom-events-with-eventemitter) that send observable output data from a child to a parent component -->\n<ul>\n<li data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"9vyk1jk3ikv01e3tbkl5s99lh\">HTTP 模块使用可观察对象来处理 AJAX 请求和响应。</li>\n<li data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"1ilxscw1bnlj8glcpeo65bcm3\">路由器和表单模块使用可观察对象来监听对用户输入事件的响应。</li>\n</ul>\n<h2 id=\"transmitting-data-between-components\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"op2ax4i79fc3szgry5yliib5\">在组件之间传递数据<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/observables-in-angular#transmitting-data-between-components\"><i class=\"material-icons\">link</i></a></h2>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"2e1uouugx85mgbqq8qp5jtulj\">Angular 提供了一个 <code><a href=\"api/core/EventEmitter\" class=\"code-anchor\">EventEmitter</a></code> 类，它用来通过组件的 <a href=\"guide/inputs-outputs#output\"><code>@Output()</code> 装饰器</a> 发送一些值。<code><a href=\"api/core/EventEmitter\" class=\"code-anchor\">EventEmitter</a></code> 扩展了 <a href=\"https://rxjs.dev/api/index/class/Subject\">RxJS <code>Subject</code></a>，并添加了一个 <code>emit()</code> 方法，这样它就可以发送任意值了。当你调用 <code>emit()</code> 时，就会把所发送的值传给订阅上来的观察者的 <code>next()</code> 方法。</p>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"c0gt4wftulv1rya7sli0231oe\">这种用法的例子参阅 <a href=\"api/core/EventEmitter\">EventEmitter</a> 文档。下面这个范例组件监听了 <code>open</code> 和 <code>close</code> 事件：</p>\n<code-example format=\"typescript\" language=\"typescript\">\n\n&lt;app-zippy (open)=\"onOpen($event)\" (close)=\"onClose($event)\"&gt;&lt;/app-zippy&gt;\n\n</code-example>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"c6cm09lu29572hj7wwm0lomb1\">组件的定义如下：</p>\n<code-example header=\"EventEmitter\" path=\"observables-in-angular/src/main.ts\" region=\"eventemitter\">\n\n@<a href=\"api/core/Component\" class=\"code-anchor\">Component</a>({\n  standalone: true,\n  selector: 'app-zippy',\n  template: `\n    &lt;div class=\"zippy\"&gt;\n      &lt;button type=\"button\" (click)=\"toggle()\"&gt;Toggle&lt;/button&gt;\n      &lt;div [hidden]=\"!visible\"&gt;\n        &lt;ng-content&gt;&lt;/ng-content&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;\n  `,\n})\nexport class ZippyComponent {\n  visible = true;\n  @<a href=\"api/core/Output\" class=\"code-anchor\">Output</a>() open = new <a href=\"api/core/EventEmitter\" class=\"code-anchor\">EventEmitter</a>&lt;any&gt;();\n  @<a href=\"api/core/Output\" class=\"code-anchor\">Output</a>() close = new <a href=\"api/core/EventEmitter\" class=\"code-anchor\">EventEmitter</a>&lt;any&gt;();\n\n  toggle() {\n    this.visible = !this.visible;\n    if (this.visible) {\n      this.open.emit(null);\n    } else {\n      this.close.emit(null);\n    }\n  }\n}\n\n\n</code-example>\n<h2 id=\"http\">HTTP<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/observables-in-angular#http\"><i class=\"material-icons\">link</i></a></h2>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"9be67mxukmkznx4l4hho0apgl\">Angular 的 <code><a href=\"api/common/http/HttpClient\" class=\"code-anchor\">HttpClient</a></code> 从 HTTP 方法调用中返回了可观察对象。比如，<code>http.get('/api')</code> 就会返回可观察对象。相对于基于承诺（Promise）的 HTTP API，它有一系列优点：</p>\n<ul>\n<li>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"bragv1bw64cveg925romik9w\">可观察对象不会修改服务器的响应（和在 Promise 上串联起来的 <code>.then()</code> 调用一样）。反之，你可以使用一系列操作符来按需转换这些值。</p>\n</li>\n<li>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"lcujnfhq7zi05wok22wor1v2\">HTTP 请求是可以通过 <code>unsubscribe()</code> 方法来取消的</p>\n</li>\n<li>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"dg2wxbti00wxmor2s7ldtqxeu\">请求可以进行配置，以获取进度事件的变化</p>\n</li>\n<li>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"1stnpt8uy3l1uu80g2h1d33j4\">失败的请求很容易重试</p>\n</li>\n</ul>\n<h2 id=\"async-pipe\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"bdx99qwojf3dqetee3e9nga5y\">Async 管道<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/observables-in-angular#async-pipe\"><i class=\"material-icons\">link</i></a></h2>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"6m9gkqmjpnc5qvkk15aq6yym5\"><a href=\"api/common/AsyncPipe\">AsyncPipe</a> 会订阅一个可观察对象或 Promise，并返回其发出的最后一个值。当发出新值时，该管道就会把这个组件标记为需要进行变更检查的（译注：因此可能导致刷新界面）。</p>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"69ul96uf3b2tmgreb9dhrmjs3\">下面的例子把 <code>time</code> 这个可观察对象绑定到了组件的视图中。这个可观察对象会不断使用当前时间更新组件的视图。</p>\n<code-example header=\"Using async pipe\" path=\"observables-in-angular/src/main.ts\" region=\"pipe\">\n\n@<a href=\"api/core/Component\" class=\"code-anchor\">Component</a>({\n  standalone: true,\n  selector: 'async-observable-pipe',\n  template: `&lt;div&gt;&lt;code&gt;observable|async&lt;/code&gt;:\n       <a href=\"api/common/Time\" class=\"code-anchor\">Time</a>: {{ time | async }}&lt;/div&gt;`,\n  imports: [<a href=\"api/common/CommonModule\" class=\"code-anchor\">CommonModule</a>]\n})\nexport class AsyncObservablePipeComponent {\n  time = new Observable&lt;string&gt;(observer =&gt; {\n    setInterval(() =&gt; observer.next(new Date().toString()), 1000);\n  });\n}\n\n\n</code-example>\n<h2 id=\"router\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"9a9suvh0m7vdzxj5aomuljv0d\">路由器<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/observables-in-angular#router\"><i class=\"material-icons\">link</i></a></h2>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"3qoxpxvc8e0ue7223phbh11d7\"><a href=\"api/router/Router#events\"><code>Router.events</code></a> 以可观察对象的形式提供了其事件。你可以使用 RxJS 中的 <code>filter()</code> 操作符来找到感兴趣的事件，并且订阅它们，以便根据浏览过程中产生的事件序列作出决定。例子如下：</p>\n<code-example header=\"Router events\" path=\"observables-in-angular/src/main.ts\" region=\"router\">\n\nimport { <a href=\"api/router/Router\" class=\"code-anchor\">Router</a>, <a href=\"api/router/NavigationStart\" class=\"code-anchor\">NavigationStart</a> } from '@angular/router';\nimport { filter } from 'rxjs';\n\n@<a href=\"api/core/Component\" class=\"code-anchor\">Component</a>({\n  standalone: true,\n  selector: 'app-routable',\n  template: 'Routable1Component template'\n})\nexport class Routable1Component implements <a href=\"api/core/OnInit\" class=\"code-anchor\">OnInit</a> {\n\n  navStart: Observable&lt;<a href=\"api/router/NavigationStart\" class=\"code-anchor\">NavigationStart</a>&gt;;\n\n  constructor(router: <a href=\"api/router/Router\" class=\"code-anchor\">Router</a>) {\n    // Create a new Observable that publishes only the <a href=\"api/router/NavigationStart\" class=\"code-anchor\">NavigationStart</a> event\n    this.navStart = router.events.pipe(\n      filter(evt =&gt; evt instanceof <a href=\"api/router/NavigationStart\" class=\"code-anchor\">NavigationStart</a>)\n    ) as Observable&lt;<a href=\"api/router/NavigationStart\" class=\"code-anchor\">NavigationStart</a>&gt;;\n  }\n\n  ngOnInit() {\n    this.navStart.subscribe(() =&gt; console.log('<a href=\"api/router/Navigation\" class=\"code-anchor\">Navigation</a> Started!'));\n  }\n}\n\n\n</code-example>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"4sjtijhn61nb7ebm8urtjtfyb\"><a href=\"api/router/ActivatedRoute\">ActivatedRoute</a> 是一个可注入的路由器服务，它使用可观察对象来获取关于路由路径和路由参数的信息。比如，<code><a href=\"api/router/ActivatedRoute#url\" class=\"code-anchor\">ActivatedRoute.url</a></code> 包含一个用于汇报路由路径的可观察对象。例子如下：</p>\n<code-example header=\"ActivatedRoute\" path=\"observables-in-angular/src/main.ts\" region=\"activated_route\">\n\nimport { <a href=\"api/router/ActivatedRoute\" class=\"code-anchor\">ActivatedRoute</a> } from '@angular/router';\n\n@<a href=\"api/core/Component\" class=\"code-anchor\">Component</a>({\n  standalone: true,\n  selector: 'app-routable',\n  template: 'Routable2Component template'\n})\nexport class Routable2Component implements <a href=\"api/core/OnInit\" class=\"code-anchor\">OnInit</a> {\n  constructor(private activatedRoute: <a href=\"api/router/ActivatedRoute\" class=\"code-anchor\">ActivatedRoute</a>) { }\n\n  ngOnInit() {\n    this.activatedRoute.url\n      .subscribe(url =&gt; console.log('The URL changed to: ' + url));\n  }\n}\n\n\n</code-example>\n<h2 id=\"reactive-forms\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"b2xwzrnb2ye7twpwf3t9i2eiv\">响应式表单<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/observables-in-angular#reactive-forms\"><i class=\"material-icons\">link</i></a></h2>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"37bcpi72rqbdhonjxa7747ulr\">响应式表单具有一些属性，它们使用可观察对象来监听表单控件的值。<a href=\"api/forms/FormControl\"><code>FormControl</code></a> 的 <code>valueChanges</code> 属性和 <code>statusChanges</code> 属性包含了会发出变更事件的可观察对象。订阅可观察的表单控件属性是在组件类中触发应用逻辑的途径之一。比如：</p>\n<code-example header=\"Reactive forms\" path=\"observables-in-angular/src/main.ts\" region=\"forms\">\n\nimport { <a href=\"api/forms/FormGroup\" class=\"code-anchor\">FormGroup</a> } from '@angular/forms';\n\n@<a href=\"api/core/Component\" class=\"code-anchor\">Component</a>({\n  standalone: true,\n  selector: 'app-hero-form',\n  template: 'Hero <a href=\"api/forms/Form\" class=\"code-anchor\">Form</a> Template'\n})\nexport class HeroFormComponent implements <a href=\"api/core/OnInit\" class=\"code-anchor\">OnInit</a> {\n  nameChangeLog: string[] = [];\n  heroForm!: <a href=\"api/forms/FormGroup\" class=\"code-anchor\">FormGroup</a>;\n\n  ngOnInit() {\n    this.logNameChange();\n  }\n  logNameChange() {\n    const nameControl = this.heroForm.get('name');\n    nameControl?.valueChanges.forEach(\n      (value: string) =&gt; this.nameChangeLog.push(value)\n    );\n  }\n}\n\n\n</code-example>\n<!-- links -->\n<!-- external links -->\n<!-- end links -->\n\n  <div class=\"reviewed\">最后复查时间：Mon Feb 28 2022</div>\n</div>\n\n\n<!-- links to this doc:\n - api/core/EventEmitter\n - guide/http-request-data-from-server\n - guide/router-reference\n-->\n<!-- links from this doc:\n - api/common/AsyncPipe\n - api/common/CommonModule\n - api/common/Time\n - api/common/http/HttpClient\n - api/core/Component\n - api/core/EventEmitter\n - api/core/OnInit\n - api/core/Output\n - api/forms/Form\n - api/forms/FormControl\n - api/forms/FormGroup\n - api/router/ActivatedRoute\n - api/router/ActivatedRoute#url\n - api/router/Navigation\n - api/router/NavigationStart\n - api/router/Router\n - api/router/Router#events\n - guide/inputs-outputs#output\n - guide/observables-in-angular#async-pipe\n - guide/observables-in-angular#http\n - guide/observables-in-angular#observables-in-angular\n - guide/observables-in-angular#reactive-forms\n - guide/observables-in-angular#router\n - guide/observables-in-angular#transmitting-data-between-components\n - https://rxjs.dev/api/index/class/Subject\n-->"}